---
title: "Blue Bike Boston Flow Map"
author: "Ben Resek"
date: "2023-02-01"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
library("od")
library("sf")
library("tmap")
library("dplyr")
library("readr")
library("here")
library("dodgr")
library("stplanr")
```

In this script I lean heavily on the od package vignette to 


```{r read in the data}
# read in the data and clean the column names to make processing easier
blue_bike_data  <- read_csv(here("data","202212-bluebikes-tripdata.csv")) |> janitor::clean_names()

# get blue bike station locations
station_data <- read_csv(here("data", "current_bluebikes_stations.csv"), skip = 1)|> janitor::clean_names()
```
I need to transform the data into origin-destination format. So that there is an is an origin column, destination column, and trip count column - in addition to the accessory data. 

```{r r}
start_end_count <- blue_bike_data |> 
  select(start_station_id,start_station_name, end_station_id, end_station_name) |> 
  group_by(start_station_name, end_station_name) |>
  summarize(count = n()) |> 
  select(start_station_name, end_station_name, count, everything()) |> 
  arrange(desc(count))
```


```{r make station data spatial }
station_locations <- st_as_sf(station_data, coords = c("longitude", "latitude"), crs=4326) |> select(name, everything())
```

```{r}
tmap_mode("view")
tm_shape(station_locations)+
  tm_dots(col="district")
```


To constrain the network I'm filtering out Revere. I mighgt filter out outhers
```{r}
# Filter out revere stations 
station_locations <- station_locations |> 
  filter(district!="Salem") |> 
  filter(!is.na(district))

# Filter out our rows that aren't in the station location table
station_names <- unique(station_locations$name)

start_end_count <- 
  start_end_count |> 
  filter(start_station_name %in% station_names) |> 
  filter(end_station_name %in% station_names)
```


```{r}
desire_lines <- od2line(start_end_count, station_locations)
```

```{r}
tmap_mode("view")
tm_shape(desire_lines)+
  tm_lines(lwd = "count", col = "count", palette = "blue")
```


```{r}

blue_bikes_routed <- route(l = desire_lines_sample, route_fun = route_osrm, osrm.profile = "bike")
```


```{r}
tmap_mode("plot")
tm_shape(route_test)+
  tm_lines(col = "count")
```

